ðŸŒ E1 Recycling Platform - åŽç«¯æž¶æž„å…¨è§£
è¿™æ˜¯ä¸€ä¸ªåŸºäºŽ .NET Core Web API æž„å»ºçš„åºŸå“å›žæ”¶å¹³å°åŽç«¯ç³»ç»Ÿã€‚å®ƒé‡‡ç”¨åˆ†å±‚æž¶æž„ï¼Œä¸»è¦ç”± Controllers (æŽ§åˆ¶å™¨)ã€Models (æ•°æ®æ¨¡åž‹)ã€Services (æœåŠ¡) å’Œ Middlewares (ä¸­é—´ä»¶) ç»„æˆã€‚

1. ðŸ“‚ Controllers (ä¸šåŠ¡æŒ‡æŒ¥ä¸­å¿ƒ)
ä½œç”¨ï¼šåŽç«¯çš„â€œå‰å°â€ã€‚è´Ÿè´£æŽ¥æ”¶ APP å‘æ¥çš„ HTTP è¯·æ±‚ï¼Œè°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶è¿”å›žç»“æžœã€‚

IncidentController.cs (æ ¸å¿ƒä¸šåŠ¡ - å›žæ”¶è®¢å•)

ä¸šåŠ¡ï¼šå¤„ç†ç”¨æˆ·çš„**â€œä¸Šé—¨å›žæ”¶è¯·æ±‚â€ (Pickup Request)**ã€‚

åŠŸèƒ½ï¼šå½“ç”¨æˆ·æœ‰åºŸå“è¦å–æ—¶ï¼Œæäº¤ç…§ç‰‡ã€GPS åæ ‡å’Œæè¿°ã€‚è¯¥æŽ§åˆ¶å™¨æŽ¥æ”¶è¿™äº›â€œè®¢å•â€ï¼Œå¹¶è´Ÿè´£æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆå¦‚ï¼šSubmitted å·²æäº¤ -> In Progress å¤„ç†ä¸­ -> Completed å·²å®Œæˆï¼‰ã€‚

RecyclingGuideController.cs (æ•™è‚²æ¨¡å—)

ä¸šåŠ¡ï¼šç®¡ç† APP é‡Œçš„â€œå›žæ”¶æŒ‡å—â€é¡µé¢ã€‚

åŠŸèƒ½ï¼šæä¾› YouTube æ•™å­¦è§†é¢‘é“¾æŽ¥ã€æ–‡ç« è·³è½¬é“¾æŽ¥å’Œåˆ†ç±»å›¾æ ‡ï¼Œæ•™ç”¨æˆ·å¦‚ä½•æ­£ç¡®åˆ†ç±»åºŸå“ã€‚

RecyclingController.cs (åœ°å›¾æœåŠ¡)

ä¸šåŠ¡ï¼šç®¡ç†å…¬å…±å›žæ”¶ç«™ç‚¹çš„åœ°ç†ä½ç½®ã€‚

åŠŸèƒ½ï¼šæä¾›ç«™ç‚¹çš„ç»çº¬åº¦æ•°æ®ï¼Œæ–¹ä¾¿å‰ç«¯åœ¨ Google Maps ä¸Šæ ‡è®°å‡ºæœ€è¿‘çš„å›žæ”¶ç‚¹ã€‚

AdminController.cs (åŽå°ç®¡ç†)

ä¸šåŠ¡ï¼šç®¡ç†å‘˜ä¸“ç”¨çš„æƒé™ç®¡ç†æŽ¥å£ã€‚

åŠŸèƒ½ï¼šæŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ã€ä»»å‘½æ–°çš„ç®¡ç†å‘˜ (Promote)ã€æˆ–åˆ é™¤è¿è§„ç”¨æˆ·ã€‚

AuthController.cs (å®‰å…¨å…¥å£)

ä¸šåŠ¡ï¼šè®¤è¯ç³»ç»Ÿã€‚

åŠŸèƒ½ï¼šå¤„ç†æ³¨å†Œã€ç™»å½•ã€å¿˜è®°å¯†ç ã€‚å®ƒè´Ÿè´£å‘æ”¾ JWT ä»¤ç‰Œï¼Œå¹¶ç»“åˆæ•°æ®åº“é€»è¾‘å®žçŽ°â€œå•è®¾å¤‡å¼ºåˆ¶ç™»å½•â€æœºåˆ¶ã€‚

ProfileController.cs (ä¸ªäººä¸­å¿ƒ)

ä¸šåŠ¡ï¼šç”¨æˆ·èµ„æ–™ç®¡ç†ã€‚

åŠŸèƒ½ï¼šå…è®¸ç”¨æˆ·æŸ¥çœ‹æˆ–ä¿®æ”¹è‡ªå·±çš„æ˜µç§°ã€å¤´åƒç­‰ä¿¡æ¯ã€‚

NotificationsController.cs (æ¶ˆæ¯æŽ¨é€)

ä¸šåŠ¡ï¼šé›†æˆ Firebase (FCM)ã€‚

åŠŸèƒ½ï¼šç»™ç”¨æˆ·æ‰‹æœºå‘é€å¼¹çª—é€šçŸ¥ï¼ˆä¾‹å¦‚é€šçŸ¥ç”¨æˆ·ï¼šâ€œå›žæ”¶äººå‘˜å·²å‡ºå‘â€ï¼‰ã€‚

AiController.cs (æ™ºèƒ½è¯†åˆ«)

ä¸šåŠ¡ï¼šAI è¾…åŠ©åŠŸèƒ½ã€‚

åŠŸèƒ½ï¼šå¤„ç†å›¾åƒè¯†åˆ«è¯·æ±‚ï¼ˆä¾‹å¦‚è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·ä¸Šä¼ çš„ç…§ç‰‡æ˜¯å¡‘æ–™è¿˜æ˜¯çº¸å¼ ï¼‰ã€‚

2. ðŸ“‚ Middlewares (å®‰å…¨æ‹¦æˆªå™¨)
ä½œç”¨ï¼šèµ°å»Šä¸Šçš„â€œå®‰æ£€é—¨â€ã€‚è¯·æ±‚åˆ°è¾¾ Controller ä¹‹å‰å¿…é¡»ç»è¿‡è¿™é‡Œã€‚

SingleSessionMiddleware.cs (è®¾å¤‡å®‰å…¨é”)

åŠŸèƒ½ï¼šå®ƒæ‹¦æˆªæ¯ä¸€ä¸ªè¯·æ±‚ï¼Œæ£€æŸ¥ç”¨æˆ·æŒæœ‰çš„ Token æ˜¯å¦ä¸Žæ•°æ®åº“é‡Œçš„ CurrentSessionToken ä¸€è‡´ã€‚

ç›®çš„ï¼šå®žçŽ°å•è®¾å¤‡ç™»å½•ã€‚å¦‚æžœç”¨æˆ·åœ¨ç¬¬äºŒå°æ‰‹æœºç™»å½•ï¼Œæ•°æ®åº“æ ‡è®°ä¼šæ›´æ–°ï¼Œè¿™ä¸ªä¸­é—´ä»¶ä¼šç«‹åˆ»è¯†åˆ«å‡ºç¬¬ä¸€å°æ‰‹æœºçš„ Token å·²å¤±æ•ˆï¼Œå¹¶å¼ºåˆ¶å…¶ä¸‹çº¿ (è¿”å›ž 401)ã€‚

3. ðŸ“‚ Models (æ•°æ®æ¨¡åž‹å±‚)
ä½œç”¨ï¼šå®šä¹‰æ•°æ®çš„ç»“æž„ã€‚åˆ†ä¸ºâ€œæ•°æ®åº“å®žä½“â€å’Œâ€œæ•°æ®ä¼ è¾“å¯¹è±¡â€ä¸¤ç±»ã€‚

A. Entities (æ•°æ®åº“è¡¨ç»“æž„ - å­˜å…¥æ•°æ®åº“çš„)

IncidentReport.cs (å›žæ”¶è®¢å•è¡¨)

å­˜å‚¨æ ¸å¿ƒä¸šåŠ¡æ•°æ®ï¼šè° (UserId)ã€åœ¨å“ª (Lat/Lon)ã€ä»€ä¹ˆåºŸå“ (PhotoUrl/Description)ã€å½“å‰è¿›åº¦ (Status)ã€‚

ApplicationUser.cs (ç”¨æˆ·è¡¨)

ç»§æ‰¿è‡ªç³»ç»Ÿç”¨æˆ·ï¼Œé¢å¤–å¢žåŠ äº† CurrentSessionToken å­—æ®µï¼Œä¸“é—¨ç”¨äºŽé˜²å¤šè®¾å¤‡ç™»å½•ã€‚

RecyclingGuide.cs (æŒ‡å—å†…å®¹è¡¨)

å­˜å‚¨è§†é¢‘ URLã€æ–‡ç«  URLã€å›¾æ ‡ URL å’Œæ ‡é¢˜ã€‚

RecyclingSite.cs (ç«™ç‚¹è¡¨)

å­˜å‚¨å›žæ”¶ç«™çš„åå­—å’Œç»çº¬åº¦åæ ‡ã€‚

UserDevice.cs (è®¾å¤‡è¡¨)

å­˜å‚¨ç”¨æˆ·çš„ Firebase Tokenï¼Œç”¨äºŽç²¾å‡†æŽ¨é€é€šçŸ¥ç»™ç‰¹å®šæ‰‹æœºã€‚

B. DTOs (æ•°æ®ä¼ è¾“å¯¹è±¡ - å‰åŽç«¯äº¤äº’ç”¨çš„â€œå°çº¸æ¡â€)

AuthDtos.cs (è®¤è¯æ•°æ®åŒ…)

ä½œç”¨ï¼šå®šä¹‰æ³¨å†Œ/ç™»å½•æ—¶çš„è¡¨å•æ ¼å¼ã€‚ä¾‹å¦‚ LoginModel åªåŒ…å«é‚®ç®±å’Œå¯†ç ï¼Œå¹²å‡€åˆ©è½ã€‚

IncidentHistoryDto.cs (åŽ†å²è®¢å•ç®€æŠ¥)

ä½œç”¨ï¼šä¸“ç”¨äºŽâ€œæˆ‘çš„è®¢å•åˆ—è¡¨â€é¡µé¢ã€‚

åŒºåˆ«ï¼šå®ƒæ¯”å®Œæ•´çš„ IncidentReport æ›´è½»é‡ï¼ŒåªåŒ…å«åˆ—è¡¨éœ€è¦æ˜¾ç¤ºçš„å­—æ®µï¼ˆå¦‚æ—¥æœŸã€ç¼©ç•¥å›¾ã€çŠ¶æ€ï¼‰ï¼Œä¸ºäº†æé«˜ APP åŠ è½½é€Ÿåº¦ã€‚

ProfileDtos.cs (ä¸ªäººèµ„æ–™åŒ…)

ä½œç”¨ï¼šå®šä¹‰ç”¨æˆ·ä¿®æ”¹èµ„æ–™æ—¶å…è®¸æäº¤çš„æ•°æ®ã€‚

å®‰å…¨æ€§ï¼šé˜²æ­¢ç”¨æˆ·åœ¨ä¿®æ”¹èµ„æ–™æ—¶æ¶æ„ç¯¡æ”¹æ•æ„Ÿå­—æ®µï¼ˆå¦‚ä½™é¢æˆ–ç®¡ç†å‘˜æƒé™ï¼‰ã€‚

RecyclingGuideDtos.cs (æŒ‡å—åˆ›å»ºåŒ…)

ä½œç”¨ï¼šç®¡ç†å‘˜åœ¨åŽå°æ·»åŠ æ–°è§†é¢‘æ—¶å¡«å†™çš„æ•°æ®æ ¼å¼ã€‚

4. ðŸ“‚ Services (æœåŠ¡å±‚)
ä½œç”¨ï¼šå°è£…å¤æ‚çš„å¤–éƒ¨é€»è¾‘ã€‚

GmailEmailService.cs (é‚®ä»¶æŠ•é€’å‘˜)

åŠŸèƒ½ï¼šå°è£… SMTP åè®®ï¼Œé€šè¿‡ Gmail æœåŠ¡å™¨ç»™ç”¨æˆ·å‘é€éªŒè¯ç æˆ–ç³»ç»Ÿé€šçŸ¥ã€‚

IEmailService.cs (æŽ¥å£æ ‡å‡†)

åŠŸèƒ½ï¼šå®šä¹‰å‘é‚®ä»¶å¿…é¡»æœ‰å“ªäº›å‚æ•°ï¼ˆæ”¶ä»¶äººã€æ ‡é¢˜ã€å†…å®¹ï¼‰ï¼Œæ–¹ä¾¿ä»£ç è§£è€¦ã€‚

5. æ ¸å¿ƒé…ç½®æ–‡ä»¶ (åœ°åŸº)
Program.cs (å¯åŠ¨å…¥å£)

åŠŸèƒ½ï¼šç¨‹åºçš„æ€»å¼€å…³ã€‚é…ç½®æ•°æ®åº“è¿žæŽ¥ã€æ³¨å†Œæ‰€æœ‰æœåŠ¡ã€å¯ç”¨ä¸­é—´ä»¶ï¼Œä»¥åŠç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨è®¾ç½®ç®¡ç†å‘˜ (Seeding)ã€‚

app.db (æ•°æ®åº“)

åŠŸèƒ½ï¼šSQLite æ•°æ®åº“æ–‡ä»¶ï¼Œæ‰€æœ‰æ•°æ®ï¼ˆç”¨æˆ·ã€è®¢å•ã€è§†é¢‘é“¾æŽ¥ï¼‰éƒ½åœ¨è¿™é‡Œã€‚

firebase-admin-key.json (æŽ¨é€å¯†é’¥)

åŠŸèƒ½ï¼šè¿žæŽ¥ Google Firebase æœåŠ¡çš„â€œé€šè¡Œè¯â€ã€‚


ðŸŒ E1 Recycling Platform - Backend Architecture Explained

This is a backend system for a waste recycling platform built on the .NET Core Web API. It adopts a layered architecture, primarily composed of Controllers, Models, Services, and Middlewares.

1. ðŸ“‚ Controllers (Business Command Center)

Role: The "front end" of the backend. Responsible for receiving HTTP requests from the app, invoking business logic, and returning results.

IncidentController.cs (Core Business - Recycling Orders)

Business: Handles users' **"Pickup Requests"**.

Function: When a user has waste to sell, they submit photos, GPS coordinates, and a description. This controller receives these "orders" and is responsible for updating the order status (e.g., Submitted -> In Progress -> Completed).

RecyclingGuideController.cs (Education Module)

Business Function: Manages the "Recycling Guide" page within the app.

Function: Provides links to YouTube tutorial videos, article links, and category icons to teach users how to properly sort recyclables.


RecyclingController.cs (Map Service)

Business Function: Manages the geographic locations of public recycling stations.

Function: Provides the latitude and longitude data of each station, allowing the frontend to mark the nearest recycling point on Google Maps.


AdminController.cs (Admin Panel)

Business Function: A dedicated permission management interface for administrators.

Function: Allows users to view the entire user list, appoint new administrators (Promote), or delete users who violate regulations.


AuthController.cs (Security Entry Point)

Business Function: Authentication system.

Function: Handles registration, login, and forgotten password handling. It issues JWT tokens and implements a "forced login on a single device" mechanism based on database logic.


ProfileController.cs (Personal Center)

Business Function: User profile management.

Functionality: Allows users to view or modify their nickname, avatar, and other information.

NotificationsController.cs (Push Notifications)

Business Functionality: Integrates with Firebase (FCM).

Functionality: Sends pop-up notifications to users' phones (e.g., notifying users that "recycling personnel have departed").

AiController.cs (Intelligent Recognition)

Business Functionality: AI-assisted functionality.

Functionality: Handles image recognition requests (e.g., automatically identifying whether a user-uploaded photo is plastic or paper).

2. ðŸ“‚ Middlewares (Security Interceptors)

Functionality: Like a "security gate" in a corridor. Requests must pass through here before reaching the Controller.

SingleSessionMiddleware.cs (Device Security Lock)

Functionality: Intercepts every request and checks if the user's token matches the CurrentSessionToken in the database.

Purpose: Enables single-device login. If a user logs in on a second phone, the database flag will be updated, and this middleware will immediately recognize that the first phone's token has expired and force it offline (returning a 401 error). 3. ðŸ“‚ Models (Data Model Layer)

Purpose: Defines the data structure. Divided into two categories: "Database Entities" and "Data Transfer Objects".

A. Entities (Database Table Structure - Storing Data in the Database)

IncidentReport.cs (Recycling Order Table)

Stores core business data: Who (UserId), Where (Lat/Lon), What kind of waste (PhotoUrl/Description), Current progress (Status).

ApplicationUser.cs (User Table)

Inherits from the system user table, with an additional CurrentSessionToken field specifically for preventing multi-device login.

RecyclingGuide.cs (Guide Content Table)

Stores video URLs, article URLs, icon URLs, and titles.

RecyclingSite.cs (Site Table)

Stores the name and latitude/longitude coordinates of the recycler station.

UserDevice.cs (Device Table)

Stores the user's Firebase Token for targeted push notifications to specific mobile phones.

B. Data Transfer Objects (DTOs) - "Small notes" used for front-end and back-end interaction

AuthDtos.cs (Authentication Data Package)

Purpose: Defines the form format for registration/login. For example, LoginModel only contains email and password, keeping it clean and concise.

IncidentHistoryDto.cs (Order History Briefing)

Purpose: Dedicated to the "My Orders List" page.

Difference: It is lighter than the full IncidentReport, containing only the fields needed for the list to display (such as date, thumbnail, status), to improve app loading speed.

ProfileDtos.cs (Personal Profile Package)

Purpose: Defines the data allowed to be submitted when users modify their profiles.

Security: Prevents users from maliciously tampering with sensitive fields (such as balance or administrator privileges) when modifying their profiles.

RecyclingGuideDtos.cs (Guide Creation Package)

Purpose: The data format filled in by administrators when adding new videos in the backend.

4. ðŸ“‚ Services (Service Layer)

Purpose: Encapsulates complex external logic.

GmailEmailService.cs (Email Delivery Personnel)

Function: Encapsulates the SMTP protocol to send verification codes or system notifications to users via the Gmail server.

IEmailService.cs (Interface Standard)

Function: Defines the parameters required for sending emails (recipient, subject, content), facilitating code decoupling.

5. Core Configuration Files (Foundation)

Program.cs (Startup Entry Point)

Function: The program's master switch. Configures database connections, registers all services, enables middleware, and automatically sets the administrator (Seeding) upon program startup.

app.db (Database)

Function: SQLite database file; all data (users, orders, video links) is stored here.

firebase-admin-key.json (Push Key)

Function: The "passport" for connecting to Google Firebase services.